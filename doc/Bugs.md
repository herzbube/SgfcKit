# Bugs and limitations

## String data must be Unicode

### Marshaling uses UTF-8

SgfcKit uses `NSString` everywhere. `NSString` is designed to hold a Unicode string.

When SgfcKit marshals data from `NSString` to the C++ string type `std::string` (used by libsgfc++), and vice versa, it has to specify a text encoding. SgfcKit always uses the UTF-8 text encoding. The library client has no choice in this matter and must follow some rules that arise as a consequence.

### Encoding mode while reading SGF data

When SgfcKit reads SGF data using `SGFCDocumentReader` it uses UTF-8 to marshal string data from `std::string` into `NSString` because that is the text encoding in which libsgfc++ (and the underlying SGFC) provides string data when encoding modes 1 and 2 are used.

If a library client uses encoding mode 3 to read SGF data then libsgfc++ (and the underlying SGFC) don't provide the string data in any particular text encoding, so marshaling with UTF-8 will generate wrong data.

**A library client should therefore never use encoding mode 3 to read SGF data!**

### Encoding mode while writing SGF data

When a library client uses `SGFCDocumentWriter` to write SGF data **it should never use encoding mode 3**. The consequences may not be as severe as when reading SGF data because no re-encoding takes place after encoding mode 3 is applied, but libsgfc++ (and the underlying SGFC) may still fail to correctly process the SGF data if it contains Unicode characters that are not ASCII-safe.

The document `SgfNotes.md` in the libsgfc++ project has a large section about what ASCII-safe means. This information is not reproduced here in SgfcKit because it is too extensive to maintain in two places.

### CA property value while writing SGF data

When SgfcKit writes a document object tree using `SGFCDocumentWriter` it uses UTF-8 to marshal string data from `NSString` into `std::string` because that is the most convenient and safest text encoding for Unicode.

It is vital that the document object tree that is being written does **not** contain a CA property value that specifies some other text encoding that is not UTF-8.

How do CA property values end up in a document object tree?

- If the document object tree was generated by reading SGF data with `SGFCDocumentReader` then the document object tree always contains CA[UTF-8].
- If the document object tree was generated programmatically by the library client, it is the library client's responsibility to set (or not set) a CA property value.
  - It is safe to omit the CA property value because `SGFCDocumentWriter` uses UTF-8 as the default text encoding, and CA[UTF-8] will be written to the final output even if the CA property value was missing in the original document object tree.
  - A library client may explicitly set CA[UTF-8] if it wishes to do so.
  - **Under no circumstances must the library client set a CA property value that is not "UTF-8"!**

